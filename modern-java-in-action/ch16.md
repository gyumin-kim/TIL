# CompletableFuture : 안정적 비동기 프로그래밍

# 16.1 Future의 단순 활용
- Future
  - 미래의 어느 시점에 결과를 얻는 모델에 활용 (Java 5~)
  - 계산이 끝났을 때 결과에 접근할 수 있는 참조를 제공
- 시간이 걸릴 수 있는 작업을 Future 내부로 설정하면, 호출자(caller) 스레드가 결과를 기다리는 동안 다른 작업을 수행할 수 있다.
- 기존의 Future, 자바 8부터는 아래의 기능들을 선언형으로 이용할 수 있도록 CompletableFuture 클래스(Future 인터페이스의 구현체)를 제공한다.
  - 두 개의 비동기 계산 결과를 하나로 합친다.
  - Future 집합이 실행하는 모든 태스크의 완료를 기다린다.
  - Future 집합에서 가장 빨리 완료되는 태스크를 기다렸다가 결과를 얻는다.
  - 프로그램적으로 Future를 완료시킨다.
  - Future 완료 동작에 반응한다.

## 동기 API와 비동기 API
- 동기 API
  - 메서드를 호출 -> 메서드가 계산을 완료할 때까지 기다림 -> 메서드가 반환되면 호출자는 반환된 값으로 계속 다른 동작을 수행
  - 호출자(caller)와 피호출자(callee)가 각각 다른 스레드에서 실행되는 상황이더라도, 호출자는 피호출자의 도착 완료를 기다린다.
  - blocking call
- 비동기 API
  - 메서드가 즉시 반환되며, 끝내지 못한 나머지 작업을 호출자 스레드와 동기적으로 실행될 수 있도록 다른 스레드에 할당한다.
  - 다른 스레드에 할당된 나머지 계산 결과는 콜백 메서드를 호출해서 전달하거나, 호출자가 '계산 결과가 끝날 때까지 기다림' 메서드를 추가로 호출하면서 전달된다.
  - non-blocking call

# 16.2 비동기 API 구현
- Future는 결과값의 핸들일 뿐이며, 계산이 완료되면 get 메서드로 결과를 얻을 수 있다.
- `public Future<Double> getPriceAsync(String product) { ... }`
    - 위 메서드는 즉시 반환되므로, 호출자(caller) 스레드는 다른 작업을 수행할 수 있다.
```java
public Future<Double> getPriceAsync(String product) {
	CompletableFuture<Double> futurePrice = new CompletableFuture<>();  // 계산 결과를 포함할 CompletableFuture를 생성
	new Thread(() -> {
		double price = calculatePrice(product);  // 다른 스레드에서 비동기적으로 계산을 수행(calculatePrice()는 계산이 오래 걸리는 메서드라고 가정)
		futurePrice.complete(price);  // 오랜 시간이 걸리는 계산이 완료되면 Future에 값을 설정
	}).start();
	return futurePrice;  // 계산 결과가 완료되길 기다리지 않고 Future를 반환
}
```